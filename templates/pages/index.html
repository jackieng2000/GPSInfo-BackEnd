<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Info Input (HTML Using Django RESTful framework and JWT)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.43/moment-timezone-with-data.min.js"></script>
    <style>
        body {
            background: linear-gradient(to bottom, #e0f2fe, #bae6fd);
            min-height: 100vh;
        }
        .error {
            color: #dc2626;
            font-size: 0.875rem;
        }
        .form-input {
            transition: all 0.3s ease;
            border-width: 1px;
        }
        .form-input:focus {
            ring: 2px solid #3b82f6;
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
        }
        .table-row:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="font-sans text-gray-800">
    <div class="container mx-auto p-4 max-w-7xl">
        <!-- Login Section -->
        <section id="login-section" class="mb-8">
            <h1 class="text-3xl font-bold text-center text-blue-600 mb-6">GPS Info Input Using Django RESTful API & JWT</h1>
            <form id="login-form" class="bg-white shadow-lg rounded-lg p-6 max-w-md mx-auto">
                <div class="mb-4">
                    <label for="host-ip" class="block text-sm font-medium text-gray-700">Host IP</label>
                    <input type="text" id="host-ip" name="host-ip" value="209.97.164.73:8000" required
                           class="form-input mt-1 block w-full rounded-md border-gray-300 focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="username" name="username" value="otheruser" required
                           class="form-input mt-1 block w-full rounded-md border-gray-300 focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" name="password" required
                           class="form-input mt-1 block w-full rounded-md border-gray-300 focus:border-blue-500">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition duration-300">
                    Login
                </button>
                <p id="login-error" class="error mt-2 text-center"></p>
            </form>
        </section>

        <!-- Main Content: GPS Input and Records -->
        <div id="main-content" class="flex flex-col gap-8" style="display: none;">
            <!-- Host IP Display -->
            <div class="bg-white shadow-lg rounded-lg p-4 max-w-md mx-auto">
                <p class="text-sm font-medium text-gray-700">Connected to Host: <span id="host-ip-display" class="font-semibold"></span></p>
            </div>

            <!-- GPS Submission Section -->
            <section id="gps-section">
                <h2 class="text-2xl font-semibold text-blue-600 mb-4">Submit GPS Location End Pt 1</h2>
                <form id="gps-form" class="bg-white shadow-lg rounded-lg p-6">
                    <div class="mb-4">
                        <label for="latitude" class="block text-sm font-medium text-gray-700">Latitude</label>
                        <input type="number" id="latitude" name="latitude" step="any" required
                               class="form-input mt-1 block w-full rounded-md border-gray-300 focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label for="longitude" class="block text-sm font-medium text-gray-700">Longitude</label>
                        <input type="number" id="longitude" name="longitude" step="any" required
                               class="form-input mt-1 block w-full rounded-md border-gray-300 focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label for="altitude" class="block text-sm font-medium text-gray-700">Altitude (optional)</label>
                        <input type="number" id="altitude" name="altitude" step="any"
                               class="form-input mt-1 block w-full rounded-md border-gray-300 focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label for="accuracy" class="block text-sm font-medium text-gray-700">Accuracy (optional)</label>
                        <input type="number" id="accuracy" name="accuracy" step="any"
                               class="form-input mt-1 block w-full rounded-md border-gray-300 focus:border-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700 transition duration-300">
                        Submit GPS Location
                    </button>
                    <p id="gps-error" class="error mt-2 text-center"></p>
                </form>
            </section>

            <!-- Records Section -->
            <section id="records-section">
                <h2 class="text-2xl font-semibold text-blue-600 mb-4">Request GPS Records End Pt 2</h2>
                <form id="records-form" class="bg-white shadow-lg rounded-lg p-6 mb-6">
                    <div class="mb-4">
                        <label for="user-group" class="block text-sm font-medium text-gray-700">User Group</label>
                        <input type="text" id="user-group" name="user-group" placeholder="Enter group name"
                               class="form-input mt-1 block w-full rounded-md border-gray-300 focus:border-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-purple-600 text-white py-2 rounded-md hover:bg-purple-700 transition duration-300">
                        Fetch Records
                    </button>
                    <p id="records-error" class="error mt-2 text-center"></p>
                </form>

                <h3 class="text-xl font-semibold text-blue-600 mb-4">GPS Records</h3>
                <div class="overflow-x-auto">
                    <table class="w-full bg-white shadow-lg rounded-lg">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Timestamp</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">User</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Latitude</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Longitude</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Altitude</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Accuracy</th>
                            </tr>
                        </thead>
                        <tbody id="gps-records" class="text-gray-600">
                            <!-- Records will be populated here -->
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <!-- Logout Button -->
        <button id="logout" class="w-full max-w-xs mx-auto bg-red-600 text-white py-2 rounded-md hover:bg-red-700 transition duration-300" style="display: none;">
            Logout
        </button>
    </div>

    <script>
        // Store tokens and host
        let accessToken = '';
        let hostIp = '';

        // Clean host input to remove http:// or https://
        function cleanHostIp(input) {
            return input.replace(/^https?:\/\//, '').replace(/\/+$/, '');
        }

        // Format timestamp to YYYY-MM-DD HH:MM:SS in Asia/Hong_Kong
        function formatTimestamp(isoString) {
            return moment(isoString).tz('Asia/Hong_Kong').format('YYYY-MM-DD HH:mm:ss');
        }

        // Login form submission
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            hostIp = cleanHostIp(document.getElementById('host-ip').value);

            try {
                const response = await fetch(`http://${hostIp}/api/token/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();
                if (response.ok) {
                    accessToken = data.access;
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('main-content').style.display = 'flex';
                    document.getElementById('gps-section').style.display = 'block';
                    document.getElementById('records-section').style.display = 'block';
                    document.getElementById('logout').style.display = 'block';
                    document.getElementById('host-ip-display').textContent = hostIp; // Display hostIp
                    document.getElementById('login-error').textContent = '';
                } else {
                    document.getElementById('login-error').textContent = 'Invalid username or password';
                }
            } catch (error) {
                document.getElementById('login-error').textContent = 'Host cannot be contacted';
            }
        });

        // Submit GPS location
        document.getElementById('gps-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!accessToken) {
                document.getElementById('gps-error').textContent = 'Please login first';
                return;
            }

            const latitude = parseFloat(document.getElementById('latitude').value);
            const longitude = parseFloat(document.getElementById('longitude').value);
            const altitude = document.getElementById('altitude').value ? parseFloat(document.getElementById('altitude').value) : null;
            const accuracy = document.getElementById('accuracy').value ? parseFloat(document.getElementById('accuracy').value) : null;

            try {
                const response = await fetch(`http://${hostIp}/api/gpslocations/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({ latitude, longitude, altitude, accuracy })
                });
                if (response.ok) {
                    document.getElementById('gps-form').reset();
                    document.getElementById('gps-error').textContent = 'GPS location submitted successfully';
                } else {
                    document.getElementById('gps-error').textContent = 'Failed to submit GPS location';
                }
            } catch (error) {
                document.getElementById('gps-error').textContent = 'Host cannot be contacted';
            }
        });

        // Fetch GPS records
        document.getElementById('records-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!accessToken) {
                document.getElementById('records-error').textContent = 'Please login first';
                return;
            }

            const userGroup = document.getElementById('user-group').value;
            const url = userGroup 
                ? `http://${hostIp}/api/gpslocations/latest/?group=${encodeURIComponent(userGroup)}`
                : `http://${hostIp}/api/gpslocations/latest/`;

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                const records = await response.json();
                if (response.ok) {
                    const tbody = document.getElementById('gps-records');
                    tbody.innerHTML = '';
                    records.forEach(record => {
                        const row = document.createElement('tr');
                        row.className = 'table-row';
                        row.innerHTML = `
                            <td class="py-2 px-4">${formatTimestamp(record.timestamp)}</td>
                            <td class="py-2 px-4">${record.username || 'N/A'}</td>
                            <td class="py-2 px-4">${record.latitude}</td>
                            <td class="py-2 px-4">${record.longitude}</td>
                            <td class="py-2 px-4">${record.altitude || 'N/A'}</td>
                            <td class="py-2 px-4">${record.accuracy || 'N/A'}</td>
                        `;
                        tbody.appendChild(row);
                    });
                    document.getElementById('records-error').textContent = records.length === 0 ? 'No records found' : '';
                } else {
                    document.getElementById('records-error').textContent = 'Failed to fetch records';
                }
            } catch (error) {
                document.getElementById('records-error').textContent = 'Host cannot be contacted';
            }
        });

        // Logout
        document.getElementById('logout').addEventListener('click', () => {
            accessToken = '';
            hostIp = '';
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('gps-section').style.display = 'none';
            document.getElementById('records-section').style.display = 'none';
            document.getElementById('logout').style.display = 'none';
            document.getElementById('host-ip-display').textContent = ''; // Clear hostIp display
            document.getElementById('login-form').reset();
            document.getElementById('gps-form').reset();
            document.getElementById('records-form').reset();
            document.getElementById('gps-records').innerHTML = '';
            document.getElementById('login-error').textContent = '';
            document.getElementById('gps-error').textContent = '';
            document.getElementById('records-error').textContent = '';
        });
    </script>
</body>
</html>